This repository is for the computation of functional connectivities (covariance matrices) for patients in the HCP_1200 dataset. There are 1113 patients in the HCP_1200 dataset. A subset of them have at least one (of two possible) fmri scans for the REST1 portion of the dataset. Each available scan is parcelized according to an atlas (Deskian or Destreuix), activity values are averaged in these parcellizations for each time point thus creating a vector observation (each entry corresponds to a brain regions). These observations are then used to compute some functional connectivity matrix, either using all observations or windowed/sampled subsets.

If you would like to download these raw fmri/atlas files for yourself, see my other repo hcp-download-script here:
    https://github.com/maxwass/hcp-download-script

If you would like to read more about this data and how it was collected, see the review paper:
    https://pubmed.ncbi.nlm.nih.gov/22366334/

Assumed directory structure:
    -It is assumed that all required files are in a directory named 'brain_data', and each patient has its own directory with the subject id as the directory name.
    -If directory path is changed, update the way the path2fmri variable is constructed appropriately in files _______
 
## Things to change for different machines **
1) utils/path_to_project()
    specify local path to project directory
2)



Project Layout:

fmri_processing/ ==> 
    load_functional_dtseries.m
        Takes raw fmri & atlas file, averages activity in atlas brain regions.
        Returns N x num_observations matrix - each column is a vector observation
    load_raw_fmri.m
        Calls cifti function for reading raw fmri files.
    load_atlas.m
        Calls cifit function for reading atlas parcellizations specified by 'atlas'.
    transform_sc.m
        Transform applied to raw scs given by Zhengwu. Makes symmetric with compressed data range.
    cifti_matlab/
        Repositiory of functions for reading brain imaging files.

fmri_to_fcs/
    windowed_signals.m
        Given matrix of vector observations (the columns) construct subsets (windows) of signals by sliding window frame over matrix.
    sc_fc_dataset.m **
        Create large tensors of fcs, scs, and metadata into a .mat file.
    random_subsets.m
        Returns equally sized subsets (slices of a tensor) of matrix of observations via sampling.
    preprocess_fcs.m
        Given tensor of fcs, apply filter to each fc slice to determine which should be removed.
    compute_fcs.m
        Script coordinating fc computation for all patients. 
        Saves .mat for each patient with fc's and relavatn metadata
        Needs data files to run.
        Output of this script (for desikan atlas) can be found here: 
        https://drive.google.com/drive/folders/1LQocAEeEI02704KrmIior4HEcXx8KxSk?usp=sharing


viz_fcs/
    fMRI_signals_explore.m
        Plot energy distribution of signals for LR and RL signals. Plot characterstics of mean vectors in time and freq.
    save_all_fc_trajectories.m
        Creates directory of lr/rl jpgs showing fc trajectory ()windowed fcs). 
    fc_trajectories_gui/  ===> visualize how fcs changes at small windows along time series
        fc_trajectories.mlapp
            GUI app to explore time series and fc tracjectories with filters.

utils/  ==> misc functions


viz_scs/
    explore_brain_data.m
        Plot graphs with increasing threshold for edges (and thus more sparsity).
    inspect_given_scs.m (todo)
        Explore features of scs (largest eigenvalues, sparsities, etc).


data_accounting/
    data_accounting.m
        Analysis on what data we have for each patients, and which scans are needed
 
    compare_datasets.m
        Viz compares old dataset given by Zhengwu to new computed dataset.
        Plotting to compare old correlation fcs to new computed correlation fcs
        Outputs jpgs showing comparison for each patient
   
    subject_list_dir_debug.m
        Found repeated subject in subject_list outputed by function in hcp-batch-download repo


construct_datasets/
    sc_fc_dataset.m **
        Create large tensors of fcs, scs, and metadata into a .mat file
    windowed_fc_dataset.m
        Creates large tensor of fcs (from windowing) and metadata in a .mat file
    fc_subsample_ds.m
        Creates large tensor of fcs (from subsampling), and metadata in a .mat file
    test_dataset_creation.m
        Ensure data placed into dataset tensors properly by reloading the raw .mat file and comparing
    
       
data/cached_desikan/
    create_cached_data.m
        Load and process fmri files with given atlas (desikan) and cache result for faster loading later.
    fix_cached_data_format.m
        For changing contents/variables of all cached files.
    rfMRI_REST1/ ==> cached data files for task REST1


data/  ==> .mat files outputted and/or used by other scripts
    brain_dataset_fc_sc_pairs.mat
        Output of sc_fc_dataset.m
        Pairs of scs and fcs (covariances and correlations of all scans available - lr and rl in REST1)
        Tensors are of shape 87x87x1064. To access one matrix use: fcs(:,:,idx_of_interest)
            If a scan is not available, the matrix will be all NaNs
        Associated metadata included (atlas used, subject ids, etc)
        Invariant: All data in same order. The fcs(:,:,i) <==> scs(:,:,i) <==> final_subject_list(i)
        *Not included in git download (too large 380 MB).*
        Link to this file: https://drive.google.com/drive/folders/1LQocAEeEI02704KrmIior4HEcXx8KxSk?usp=sharing

    fc_and_sc_set.mat
        sets of patient id
            exist_any_fc_and_sc := patients with at least one fc (lr and/or rl) and an sc
            exist_both_fc_and_sc := patients with both fcs (lr and rl) and an sc
        exist_any_fc_and_sc is used at training set

    hcp_1200_subject_list.mat
        List of all subject on HCP_1200 aws s3 server.
        Includes all patients, regardless of what scans they have.

    subject_missing_fc_data.mat
        Set of patient ids
            missing_LR = all patients in hcp_1200  w/o an LR scan for REST1
            missing_RL = all patients in hcp_1200 w/o an RL scan for REST1
            missing_LR_and_RL = patients in hcp_1200 missing LR & RL for REST1 (interesect of prev sets)
            type = string indicating which fmri data is being referenced

    correlations_desikan_old.mat
        1058 87x87 Correlation (not Covariance) matrices provided by Zhengwu to Yang, and from Yang to me.
        Unclear if these are if lr, rl, mean.
        Desikan atlas, subcortical nodes come LAST (69:87), corresponding patient ids in subject_list_sc
        Missing data for patients relative to scs_desikan.mat. Aka patients with scs but no fcs (here)
            patient ids of missing data <-> [150019, 160931, 173233, 179548, 351938, 693461, 995174]


    scs_desikan.mat
        1065 87x87 structural connectivities provided by Zhengwu.
        Desikan atlas, Subcortical nodes come FIRST (1-19), corresponding patient ids in subject_list_sc



===================Attributions========================
    Zhengwu Zhang - professor at UNC
    Martin Cole   - phd student at UofR
    FieldTrip     - use of cifti file reading libary - http://www.fieldtriptoolbox.org
    HCP           - human connectome project - http://www.humanconnectome.org


If you make use of this repository, please cite:
-Wasserman, Mateos ....PAPER TO BE POSTED

If you make use of the DATA in this repository, please ALSO cite:
-Zhang, Zhengwu, Maxime Descoteaux, Jingwen Zhang, Gabriel Girard, Maxime Chamberland, David Dunson, Anuj Srivastava, and Hongtu Zhu. "Mapping population-based structural connectomes." NeuroImage 172 (2018): 130-145.

-Zhang, Zhengwu, Genevera I. Allen, Hongtu Zhu, and David Dunson. "Tensor network factorizations: Relationships between brain structural connectomes and traits." Neuroimage 197 (2019): 330-343.


Acknowledgements/citations as requirement for use of HCP Data:
-"Data were provided [in part] by the Human Connectome Project, WU-Minn Consortium (Principal Investigators: David Van Essen and Kamil Ugurbil; 1U54MH091657) funded by the 16 NIH Institutes and Centers that support the NIH Blueprint for Neuroscience Research; and by the McDonnell Center for Systems Neuroscience at Washington University."

-Matthew F. Glasser, Stamatios N. Sotiropoulos, J. Anthony Wilson, Timothy S. Coalson, Bruce Fischl, Jesper L. Andersson, Junqian Xu, Saad Jbabdi, Matthew Webster, Jonathan R. Polimeni, David C. Van Essen, and Mark Jenkinson (2013).
The minimal preprocessing pipelines for the Human Connectome Project. Neuroimage 80: 105-124.

-Jenkinson M, Beckmann CF, Behrens TE, Woolrich MW, and Smith SM. (2012). FSL. NeuroImage, 62:782-790. 

-Fischl B. (2012). FreeSurfer. NeuroImage, 62:774-781.

-Jenkinson M, Bannister PR, Brady JM, and Smith SM. (2002). Improved optimisation for the robust and accurate linear registration and motion correction of brain images. NeuroImage 17(2):825-841.

-Glasser MF, and Van Essen DC. (2011). Mapping human cortical areas in vivo based on myelin content as revealed by T1- and T2-weighted MRI. J Neurosci. 31:11597-11616


Links to HCP compliance rules
    https://www.humanconnectome.org/study/hcp-young-adult/document/wu-minn-hcp-consortium-open-access-data-use-terms
    https://www.humanconnectome.org/study/hcp-young-adult/document/hcp-citations


